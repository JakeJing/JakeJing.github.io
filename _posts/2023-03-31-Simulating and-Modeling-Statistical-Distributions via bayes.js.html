<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      Simulating and Modeling Statistical Distributions via bayes.js
    </title>
    <meta property="og:type" content="article" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
      integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0"
      crossorigin="anonymous"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
      integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
      integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
      crossorigin="anonymous"
      onload="renderMathInElement(document.body);"
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
          delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "$", right: "$", display: false },
          ],
        });
      });
    </script>
    <link
      rel="stylesheet"
      href="https://raw.githubusercontent.com/JakeJing/jakejing.github.io/master/_posts/style.css"
    />
    <style>
      h1 {
        font-family: "Times New Roman", Times, serif;
        font-size: 20px;
      }
      .input-cell {
        width: 130px;
        height: 25px;
        text-align: center;
        font-family: "Times New Roman", Times, serif;
        font-size: 18px;
      }
    </style>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"
      charset="utf-8"
    ></script>
    <script src="https://d3js.org/d3-random.v2.min.js"></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.plot.ly/plotly-latest.min.js"
    ></script>
    <style></style>
    <script
      type="text/javascript"
      src="https://rawgit.com/rasmusab/bayes.js/master/mcmc.js"
    ></script>
    <script
      type="text/javascript"
      src="https://rawgit.com/rasmusab/bayes.js/master/distributions.js"
    ></script>
  </head>
  <main>
    <p _msttexthash="134721496" _msthash="11">
      I have been thinking about building a web app for simulating data with
      given parameters, and recover the parameters with Bayesian MCMC samplers
      in JavaScript. This web app can not only make the steps more transparent,
      but also help us understand the <em>magic</em> of Bayesian MCMC approach.
      More importantly, I have benefited from this simulation-based way of
      thinking, so I would like to promote it in my blog.
    </p>
    <p _msttexthash="14220193" _msthash="12">
      I looked for some of-the-shelf softwares online, and found a JS library
      <a href="https://github.com/rasmusab/bayes.js">bayes.js</a> developed by
      Rasmus Bååth. He also wrote a
      <a
        href="https://www.sumsar.net/blog/2015/12/bayes-js-a-small-library-for-doing-mcmc-in-the-browser/"
        >blog</a
      >
      to introduce the library. I strongly recommend you to first read his blog
      to get some key ideas behind it. The library includes an adaptive MCMC
      sampler (<code>AmwgSampler</code>) in
      <a
        href="https://raw.githubusercontent.com/rasmusab/bayes.js/master/mcmc.js"
        >mcmc.js</a
      >
      and some common probability distributions in
      <a
        href="https://raw.githubusercontent.com/rasmusab/bayes.js/master/distributions.js"
        >distributions.js</a
      >. There are also some examples, e.g., you can use
      <strong>bayes.js</strong> to fit a Normal distribution and plot the
      posterior distributions of parameters via
      <a href="https://cdn.plot.ly/plotly-latest.min.js">plotly.js</a>.
    </p>
    <p _msttexthash="54549365" _msthash="13">
      This blog heavily relies on Bååth's library and his implimentations. I
      really appreciate his efforts to build a web app for Bayesian data
      analysis in JavaScript. Here I made some small adjustments by
      <strong
        >(1) including the data generating process by using
        <a href="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"
          >d3.js</a
        ></strong
      >;
      <strong
        >(2) simutaneously updating the posterior distributions with the true
        parameters indicated by red vertical lines</strong
      >; (3) <strong>adding buttons to display messages and warnings </strong>.
      These changes are purely my personal tastes, since I want to simulate data
      with valid parameters from a probabilitic distribution, and check the
      performance of the posterior estimates against the original parameter
      values. This seems to be quite straightforward and easy to implement. With
      some help from ChatGPT, I implemented the web app and deployed it inside
      my personal webpage powered by Jekyll. Here is the web app for Bayesian
      MCMC for Normal distributions. If you prefer a standalone version, pls
      check <a href="https://jakejing.github.io/bayes_mcmc_plot/">this page</a>.
    </p>
  </main>
  <body>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"
      charset="utf-8"
    ></script>
    <script src="https://rawgit.com/rasmusab/bayes.js/master/mcmc.js"></script>
    <script src="https://rawgit.com/rasmusab/bayes.js/master/distributions.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://d3js.org/d3-random.v2.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <div class="input-container">
      <label
        >μ:
        <input
          name="mu"
          id="mu"
          type="number"
          step="any"
          value="2"
          class="input-cell"
      /></label>
      <label
        >σ:
        <input
          name="sd"
          type="number"
          id="sd"
          min="0"
          value="2"
          step="any"
          class="input-cell"
      /></label>
      <label
        >N:
        <input
          name="n"
          type="number"
          min="1"
          value="50"
          id="n"
          class="input-cell"
      /></label>
      <button id="simulate" class="input-cell">Simulate data</button>
      <button id="startMCMC" class="input-cell">Start sampling</button>
      <button id="stopMCMC" class="input-cell">Stop sampling</button>
      <button id="clearMCMC" class="input-cell">Clear</button>
    </div>
    <div id="message"></div>
    <div id="mcmc_plots_div"></div>
    <script>
      // Get DOM elements
      const muInput = document.getElementById("mu");
      const sdInput = document.getElementById("sd");
      const nInput = document.getElementById("n");
      const messageDiv = document.getElementById("message");
      const simulateButton = document.getElementById("simulate");
      const startsampling = document.getElementById("startMCMC");
      const stopsampling = document.getElementById("stopMCMC");
      const clearsampling = document.getElementById("clearMCMC");

      // Define the global variables data
      let data = [];
      // global Input_params for the vertical lines in the plot
      let Input_params = {
        μ: parseFloat(muInput.value),
        σ: parseFloat(sdInput.value),
      };

      // Add event listener for the "Simulate" button
      simulateButton.addEventListener("click", function () {
        const mu = parseFloat(muInput.value);
        const sd = parseFloat(sdInput.value);
        const n = parseInt(nInput.value);
        // Check if the initial values are valid
        if (sd <= 0 || n < 1) {
          window.alert("Invalid parameter!");
        } else {
          const sim = d3.range(n).map(function () {
            return d3.randomNormal(mu, sd)();
          });
          if (sim.length > 0) {
            data = sim;
            Input_params["μ"] = mu;
            Input_params["σ"] = sd;
            window.alert("Simulation done, and pls start sampling!");
          } else {
            window.alert("Please simulate data first!");
          }
        }
      });

      var params = {
        μ: { type: "real" },
        σ: { type: "real", lower: 0 },
      };
      var param_names = Object.keys(params);
      var params_to_plot = Object.keys(params);

      var log_post = function (state, data) {
        var log_post = 0;
        // Priors
        log_post += ld.norm(state.μ, 0, 100);
        log_post += ld.unif(state.σ, 0, 100);
        // Likelihood
        for (var i = 0; i < data.length; i++) {
          log_post += ld.norm(data[i], state.μ, state.σ);
        }
        return log_post;
      };

      // Setting up the plots
      var plot_margins = { l: 40, r: 10, b: 40, t: 40, pad: 4 };
      let sampler = new mcmc.AmwgSampler(params, log_post, data);
      sampler.burn(1000);
      let samples = sampler.sample(1);

      for (var i = 0; i < params_to_plot.length; i++) {
        var param = params_to_plot[i];
        $("div#mcmc_plots_div").append(
          "<div>" +
            '<div id = "' +
            param +
            "_trace_div" +
            '" style="width:350px;height:250px;display: inline-block;"></div>' +
            '<div id = "' +
            param +
            "_hist_div" +
            '" style="width:350px;height:250px;display: inline-block;"></div>' +
            "</div>"
        );
        Plotly.plot(
          $("div#" + param + "_trace_div")[0],
          [{ y: samples[param] }],
          {
            margin: plot_margins,
            title: "Traceplot of " + param,
          }
        );
        Plotly.plot(
          $("div#" + param + "_hist_div")[0],
          [{ x: samples[param], type: "histogram" }],
          { margin: plot_margins, title: "Posterior of " + param }
        );
      }

      function update_trace_plots() {
        for (var i = 0; i < params_to_plot.length; i++) {
          var param = params_to_plot[i];
          Plotly.restyle($("div#" + param + "_trace_div")[0], {
            y: [samples[param]],
          });
        }
      }

      function update_histograms() {
        for (var i = 0; i < params_to_plot.length; i++) {
          // Create a histogram trace
          // var histogramData = {
          //   x: [samples[param]],
          //   type: "histogram",
          // };

          var param = params_to_plot[i];
          Plotly.restyle($("div#" + param + "_hist_div")[0], {
            x: [samples[param]],
            xbins: {},
          });
          const y_max = parseFloat(
            document.getElementById(param + "_hist_div")["layout"]["yaxis"][
              "range"
            ][1]
          );
          Plotly.relayout($("div#" + param + "_hist_div")[0], {
            // yaxis: { range: [0, y_max] },
            shapes: [
              {
                type: "line",
                x0: Input_params[param],
                y0: 0,
                x1: Input_params[param],
                y1: y_max * 0.95, // 0.95 is the best scale
                // y1: null,
                line: {
                  color: "red",
                  width: 4,
                  dash: "dash",
                },
              },
            ],
          });
        }
      }

      var clear_samples = function () {
        samples = sampler.sample(1);
        update_trace_plots();
        // update_histograms(); // replace this with the following code
        clearTimeout(sample_loop_timeout_id);
        for (var i = 0; i < params_to_plot.length; i++) {
          var param = params_to_plot[i];
          Plotly.restyle($("div#" + param + "_hist_div")[0], {
            x: [samples[param]],
            xbins: {},
          });
          Plotly.relayout($("div#" + param + "_hist_div")[0], {
            // yaxis: { range: [0, 1] },
            yaxis: { range: null },
            shapes: null,
          });
        }
      };

      var sample_loop_timeout_id;
      var sample_loop = function (params, log_post, data) {
        var n_samples = Math.min(
          250,
          Math.ceil(samples[param_names[0]].length / 10)
        );
        var more_samples = sampler.sample(n_samples);
        for (var i = 0; i < param_names.length; i++) {
          var param = param_names[i];
          Array.prototype.push.apply(samples[param], more_samples[param]);
        }
        update_trace_plots();
        update_histograms();
        sample_loop_timeout_id = setTimeout(sample_loop, 1);
      };

      var stop_sample_loop = function () {
        clearTimeout(sample_loop_timeout_id);
        update_trace_plots();
        update_histograms();
      };

      // Add event listener for the "startsampling" button
      startsampling.addEventListener("click", function () {
        // if sampling has begun once (bcs stopMCMC.disabled is true), continue the sampling
        if (document.getElementById("stopMCMC").disabled) {
          sample_loop(params, log_post, data);
          document.getElementById("stopMCMC").disabled = false;
        } else {
          if (data.length > 0) {
            this.disabled = true;
            document.getElementById("stopMCMC").disabled = false;
            // update the sampler with new data after the click
            sampler = new mcmc.AmwgSampler(params, log_post, data);
            sampler.burn(1000);
            samples = sampler.sample(1);
            sample_loop(params, log_post, data);
          } else {
            window.alert("Please simulate data first!");
          }
        }
      });

      // Add event listener for the "stopsampling" button
      stopsampling.addEventListener("click", function () {
        if (data.length > 0) {
          this.disabled = true;
          document.getElementById("startMCMC").disabled = false;
          stop_sample_loop();
        } else {
          window.alert("Please simulate data first!");
        }
      });

      // Add event listener for the "clearsampling" button
      clearsampling.addEventListener("click", function () {
        if (data.length > 0) {
          document.getElementById("startMCMC").disabled = false;
          document.getElementById("stopMCMC").disabled = false;
          clear_samples();
        } else {
          window.alert("Please simulate data first!");
        }
      });
    </script>
  </body>
</html>
