<title>Simulating and Modeling Normal Distributions via bayes.js</title>
<h1>Bayesian MCMC for Normal distributions</h1>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"
  charset="utf-8"
></script>
<script src="https://rawgit.com/rasmusab/bayes.js/master/mcmc.js"></script>
<script src="https://rawgit.com/rasmusab/bayes.js/master/distributions.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://d3js.org/d3-random.v2.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<form id="given-params">
  <label
    >mu: <input name="mu" id="mu" type="number" step="any" class="input-cell"
  /></label>
  <label
    >sd:
    <input
      name="sd"
      type="number"
      id="sd"
      min="0"
      step="any"
      class="input-cell"
  /></label>
  <label
    >N: <input name="n" type="number" min="0" id="n" class="input-cell"
  /></label>
  <button type="submit">Simulate data</button>
</form>
<div id="mcmc_plots_div"></div>
<button
  onclick="var val = JSON.parse(localStorage.getItem('simvalue')); if (Array.isArray(val) && val.length > 0){sample_loop()}"
  id="startMCMC"
>
  Start sampling
</button>
<button onclick="stop_sample_loop()" id="stopMCMC">Pause & draw</button>
<button onclick="clear_samples()" id="clearMCMC">Clear</button>
<script>
  function simulate_data(mu, sd, n) {
    simdata = d3.range(n).map(function () {
      return d3.randomNormal(mu, sd)();
    });
    return simdata;
  }
  var form = document.querySelector("form");
  form.addEventListener("submit", function () {
    // remove event as well
    if (localStorage.getItem("simvalue")) {
      localStorage.removeItem("simvalue");
    }
    if (localStorage.getItem("sim-mu")) {
      localStorage.removeItem("sim-mu");
    }
    if (localStorage.getItem("sim-sd")) {
      localStorage.removeItem("sim-sd");
    }
    var mu = parseFloat(form.elements.mu.value);
    var sd = parseFloat(form.elements.sd.value);
    var n = parseInt(form.elements.n.value);
    simdata = simulate_data(mu, sd, n);
    localStorage.setItem("simvalue", JSON.stringify(simdata));
    localStorage.setItem("sim-mu", JSON.stringify(mu));
    localStorage.setItem("sim-sd", JSON.stringify(sd));
    // event.preventDefault(); problematic, remove this line
  });

  if (localStorage.getItem("simvalue")) {
    var data = JSON.parse(localStorage.getItem("simvalue"));
  } else {
    // data is not available, make a placeholder and generate a warning!
    console.error("Pls simulate some data!");
    var data = Array(1);
  }

  var params = {
    mu: { type: "real" },
    sd: { type: "real", lower: 0 },
  };

  var log_post = function (state, data) {
    var log_post = 0;
    // Priors
    log_post += ld.norm(state.mu, 0, 100);
    log_post += ld.unif(state.sd, 0, 100);
    // Likelihood
    for (var i = 0; i < data.length; i++) {
      log_post += ld.norm(data[i], state.mu, state.sd);
    }
    return log_post;
  };

  // Initializing the sampler and generate a sample of size 1000
  var sampler = new mcmc.AmwgSampler(params, log_post, data);
  sampler.burn(1000);
  var samples = sampler.sample(1);

  // Setting up the plots
  var plot_margins = { l: 40, r: 10, b: 40, t: 40, pad: 4 };

  var param_names = Object.keys(params);
  var params_to_plot = Object.keys(params);

  for (var i = 0; i < params_to_plot.length; i++) {
    var param = params_to_plot[i];
    $("div#mcmc_plots_div").append(
      "<div>" +
        '<div id = "' +
        param +
        "_trace_div" +
        '" style="width:350px;height:250px;display: inline-block;"></div>' +
        '<div id = "' +
        param +
        "_hist_div" +
        '" style="width:350px;height:250px;display: inline-block;"></div>' +
        "</div>"
    );
    Plotly.plot($("div#" + param + "_trace_div")[0], [{ y: samples[param] }], {
      margin: plot_margins,
      title: "Traceplot of " + param,
    });
    Plotly.plot(
      $("div#" + param + "_hist_div")[0],
      [{ x: samples[param], type: "histogram" }],
      // layout,
      { margin: plot_margins, title: "Posterior of " + param }
    );
  }

  var update_trace_plots = function () {
    for (var i = 0; i < params_to_plot.length; i++) {
      var param = params_to_plot[i];
      Plotly.restyle($("div#" + param + "_trace_div")[0], {
        y: [samples[param]],
      });
    }
  };

  var update_histograms = function () {
    for (var i = 0; i < params_to_plot.length; i++) {
      var param = params_to_plot[i];
      Plotly.restyle($("div#" + param + "_hist_div")[0], {
        x: [samples[param]],
        xbins: {},
      });
      var y_max = parseFloat(
        document.getElementById(param + "_hist_div")["layout"]["yaxis"][
          "range"
        ][1]
      );
      // if original sim params available, add vertical lines
      if (JSON.parse(localStorage.getItem("sim-" + param))) {
        // console.log("check whether params available!");
        Plotly.relayout($("div#" + param + "_hist_div")[0], {
          shapes: [
            {
              type: "line",
              x0: JSON.parse(localStorage.getItem("sim-" + param)),
              y0: 0,
              x1: JSON.parse(localStorage.getItem("sim-" + param)),
              y1: y_max,
              line: {
                color: "red",
                width: 4,
                dash: "dash",
              },
            },
          ],
        });
      } else {
        // no sim params available, change it layout as the default
        Plotly.relayout($("div#" + param + "_hist_div")[0], {
          yaxis: { range: [0, 1] },
          shapes: null,
        });
      }
    }
  };

  // Below are the functions that enables starting and stopping the
  // sampling using the buttons

  var clear_samples = function () {
    samples = sampler.sample(1);
    if (localStorage.getItem("simvalue")) {
      localStorage.removeItem("simvalue");
      // console.log("simvalue deleted from local storage");
    }
    if (localStorage.getItem("sim-mu")) {
      localStorage.removeItem("sim-mu");
      // console.log("simvalue deleted from local storage");
    }
    if (localStorage.getItem("sim-sd")) {
      localStorage.removeItem("sim-sd");
      // console.log("simvalue deleted from local storage");
    }
    update_trace_plots();
    update_histograms(); // replace this with the following code
  };

  var sample_loop_timeout_id;
  var sample_loop = function () {
    var n_samples = Math.min(
      250,
      Math.ceil(samples[param_names[0]].length / 10)
    );
    var more_samples = sampler.sample(n_samples);
    for (var i = 0; i < param_names.length; i++) {
      var param = param_names[i];
      Array.prototype.push.apply(samples[param], more_samples[param]);
    }
    update_trace_plots();
    sample_loop_timeout_id = setTimeout(sample_loop, 1);
  };

  var stop_sample_loop = function () {
    clearTimeout(sample_loop_timeout_id);
    update_trace_plots();
    update_histograms();
  };
</script>
